{% extends 'base.html' %}
{% load static %}
{% load fire_extras %}

{% block content %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<style>
  .filter-control {
    background-color: white;
    padding: 15px;
    border-radius: 5px;
    box-shadow: 0 1px 5px rgba(0,0,0,0.2);
    margin-bottom: 15px;
  }
  .filter-control select {
    width: 100%;
    padding: 8px;
    border-radius: 4px;
    border: 1px solid #ddd;
    margin-bottom: 10px;
  }
  .city-stats {
    background-color: white;
    padding: 15px;
    border-radius: 5px;
    box-shadow: 0 1px 5px rgba(0,0,0,0.2);
    margin-bottom: 15px;
  }
  .stat-card {
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 10px;
    color: white;
  }
  .stat-minor { background-color: #59d05d; }
  .stat-moderate { background-color: #fdaf4b; }
  .stat-major { background-color: #f3545d; }
  .stat-total { background-color: #1d7af3; }
</style>

<div class="page-inner">
  <div class="page-header">
    <h4 class="page-title">Fire Incidents Map</h4>
    <ul class="breadcrumbs">
      <li class="nav-home">
        <a href="#">
          <i class="flaticon-home"></i>
        </a>
      </li>
      <li class="separator">
        <i class="flaticon-right-arrow"></i>
      </li>
      <li class="nav-item">
        <a href="#">Maps</a>
      </li>
      <li class="separator">
        <i class="flaticon-right-arrow"></i>
      </li>
      <li class="nav-item">
        <a href="#">Fire Incidents</a>
      </li>
    </ul>
  </div>
  <div class="row">
    <div class="col-md-3">
      <div class="filter-control">
        <h4>Filter by City</h4>
        <form id="cityFilterForm" method="get">
          <select name="city" id="cityFilter" onchange="this.form.submit()" class="form-control">
            <option value="">All Cities</option>
            {% for city in cities %}
              <option value="{{ city }}" {% if city == selected_city %}selected{% endif %}>
                {{ city }}
              </option>
            {% endfor %}
          </select>
        </form>
      </div>

      {% if selected_city %}
        <div class="city-stats">
          <h4>{{ selected_city }} Statistics</h4>
          <div class="stat-card stat-total">
            <strong>Total Incidents:</strong> {{ city_stats|get_item:selected_city|get_item:'total' }}
          </div>
          <div class="stat-card stat-minor">
            <strong>Minor:</strong> {{ city_stats|get_item:selected_city|get_item:'minor' }}
          </div>
          <div class="stat-card stat-moderate">
            <strong>Moderate:</strong> {{ city_stats|get_item:selected_city|get_item:'moderate' }}
          </div>
          <div class="stat-card stat-major">
            <strong>Major:</strong> {{ city_stats|get_item:selected_city|get_item:'major' }}
          </div>
        </div>
      {% endif %}

      <div class="legend-control">
        <h4>Severity Levels</h4>
        <div class="stat-card stat-minor">Minor Fire</div>
        <div class="stat-card stat-moderate">Moderate Fire</div>
        <div class="stat-card stat-major">Major Fire</div>
      </div>
    </div>

    <div class="col-md-9">
      <div class="card">
        <div class="card-header">
          <h4 class="card-title">{% if selected_city %}{{ selected_city }}{% else %}All Cities{% endif %} - Fire Incidents</h4>
        </div>
        <div class="card-body">
          <div id="map" style="width: 100%; height: 600px"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
  var map = L.map('map');
  
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
  }).addTo(map);

  // Get the incidents data
  var incidents = {{ incidents|safe }};

  // Define colors for different severity levels
  var severityColors = {
    'Minor Fire': '#59d05d',    // Green
    'Moderate Fire': '#fdaf4b',  // Yellow
    'Major Fire': '#f3545d'     // Red
  };

  // Create an array to hold all the markers
  var markers = [];
  var bounds = L.latLngBounds();

  // Loop through the incidents data and create markers
  incidents.forEach(function(incident) {
    var latitude = incident.latitude;
    var longitude = incident.longitude;
    
    // Create a circle marker with color based on severity
    var marker = L.circleMarker([latitude, longitude], {
      radius: 8,
      fillColor: severityColors[incident.severity_level],
      color: '#fff',
      weight: 1,
      opacity: 1,
      fillOpacity: 0.8
    }).addTo(map);

    // Create popup content with more detailed information
    var popupContent = `
      <div style="min-width: 200px;">
        <h6 style="margin-bottom: 5px; color: ${severityColors[incident.severity_level]};">
          ${incident.severity_level}
        </h6>
        <strong>Date:</strong> ${incident.date_time}<br>
        <strong>City:</strong> ${incident.city}<br>
        <strong>Address:</strong> ${incident.address}<br>
        <strong>Description:</strong> ${incident.description}
      </div>
    `;
    
    marker.bindPopup(popupContent);

    // Bind mouseover and mouseout events
    marker.on('mouseover', function() {
      this.openPopup();
    });
    
    marker.on('mouseout', function() {
      this.closePopup();
    });

    markers.push(marker);
    bounds.extend([latitude, longitude]);
  });

  // Fit the map to show all markers if there are any
  if (markers.length > 0) {
    map.fitBounds(bounds);
  } else {
    // Default view if no incidents
    map.setView([9.81644, 118.72239], 13);
  }
</script>
{% endblock %}